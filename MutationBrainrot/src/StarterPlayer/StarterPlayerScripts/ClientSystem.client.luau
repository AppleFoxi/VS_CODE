local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local mouse = player:GetMouse()

local BuildRemoteEvent = ReplicatedStorage:WaitForChild("BuildRemoteEvent")

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏
local GRID_SIZE = 4
local isBuilding = false
local playerFieldNumber = nil
local playerFieldData = nil
local previewBlock = nil

print("‚è≥ –°–∏—Å—Ç–µ–º–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...")

-- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª–µ
BuildRemoteEvent.OnClientEvent:Connect(function(action, data)
    if action == "fieldAssigned" then
        playerFieldNumber = data.fieldNumber
        playerFieldData = data
        print("üéØ –í–∞—à–µ –ø–æ–ª–µ: " .. playerFieldNumber)
        
    elseif action == "buildSuccess" then
        print("‚úÖ –ë–ª–æ–∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω!")
        
    elseif action == "buildError" then
        print("‚ùå " .. tostring(data))
    end
end)

-- –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é –±–ª–æ–∫–∞
local function createPreviewBlock()
    if previewBlock then
        previewBlock:Destroy()
    end
    
    previewBlock = Instance.new("Part")
    previewBlock.Name = "BuildPreview"
    previewBlock.Size = Vector3.new(GRID_SIZE, GRID_SIZE, GRID_SIZE)
    previewBlock.Anchored = true
    previewBlock.CanCollide = false
    previewBlock.Material = Enum.Material.Neon
    previewBlock.BrickColor = BrickColor.new("Bright green")
    previewBlock.Transparency = 0.7
    previewBlock.Parent = workspace
    
    -- –°—Ä–∞–∑—É –ø—Ä—è—á–µ–º
    previewBlock.Position = Vector3.new(0, 1000, 0)
    
    return previewBlock
end

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –ø–æ–ª–µ –∏–≥—Ä–æ–∫–∞
local function isOnPlayerField(position)
    if not playerFieldNumber or not playerFieldData then 
        return false 
    end
    
    local fieldsFolder = workspace:FindFirstChild("PlayerFields")
    if not fieldsFolder then return false end
    
    local field = fieldsFolder:FindFirstChild("PlayerField_" .. playerFieldNumber)
    if not field then return false end
    
    local fieldCenter = field.Position
    local fieldSize = field.Size
    
    local minX = fieldCenter.X - fieldSize.X/2
    local maxX = fieldCenter.X + fieldSize.X/2
    local minZ = fieldCenter.Z - fieldSize.Z/2
    local maxZ = fieldCenter.Z + fieldSize.Z/2
    
    return position.X >= minX and position.X <= maxX and 
           position.Z >= minZ and position.Z <= maxZ
end

-- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ
local function snapToGrid(position)
    return Vector3.new(
        math.floor(position.X / GRID_SIZE) * GRID_SIZE + GRID_SIZE/2,
        math.floor(position.Y / GRID_SIZE) * GRID_SIZE + GRID_SIZE/2,
        math.floor(position.Z / GRID_SIZE) * GRID_SIZE + GRID_SIZE/2
    )
end

-- –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
local function activateBuilding()
    if not playerFieldNumber then
        print("‚ùå –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø–æ–ª—è!")
        return false
    end
    
    if not previewBlock then
        createPreviewBlock()
    end
    
    isBuilding = true
    previewBlock.Transparency = 0.3
    print("üî® –†–µ–∂–∏–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù")
    return true
end

-- –í—ã–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
local function deactivateBuilding()
    isBuilding = false
    
    if previewBlock then
        previewBlock.Position = Vector3.new(0, 1000, 0)
        previewBlock.Transparency = 0.7
    end
    
    print("üî® –†–µ–∂–∏–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –í–´–ö–õ–Æ–ß–ï–ù")
end

-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–ª–æ–∫–∞
local function placeBlock()
    if not isBuilding or not previewBlock or not playerFieldNumber then 
        return 
    end
    
    local blockPosition = previewBlock.Position
    if blockPosition.Y > 100 then  -- –ï—Å–ª–∏ –ø—Ä–µ–≤—å—é —Å–ø—Ä—è—Ç–∞–Ω
        return
    end
    
    if isOnPlayerField(blockPosition) then
        print("üîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–ª–æ–∫–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏: " .. tostring(blockPosition))
        BuildRemoteEvent:FireServer(blockPosition, "BasicBlock")
    else
        print("‚ùå –ù–µ–ª—å–∑—è —Å—Ç—Ä–æ–∏—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –ø–æ–ª—è!")
    end
end

-- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –º—ã—à–∏
mouse.Button1Down:Connect(function()
    if isBuilding then
        placeBlock()
    end
end)

mouse.Button2Down:Connect(function()
    if isBuilding then
        deactivateBuilding()
    end
end)

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
local BuildingAPI = {}

function BuildingAPI.activate()
    return activateBuilding()
end

function BuildingAPI.deactivate()
    deactivateBuilding()
end

function BuildingAPI.isActive()
    return isBuilding
end

-- –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é
RunService.Heartbeat:Connect(function()
    if not isBuilding or not previewBlock then
        return
    end
    
    local target = mouse.Target
    local hitPoint = mouse.Hit and mouse.Hit.Position
    
    if not target or not hitPoint then
        previewBlock.Position = Vector3.new(0, 1000, 0)
        return
    end
    
    -- –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é –±–ª–æ–∫
    if target.Name == "BuildPreview" then
        return
    end
    
    local snappedPos = snapToGrid(hitPoint)
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –ø–æ–ª–µ –∏–≥—Ä–æ–∫–∞
    if isOnPlayerField(snappedPos) then
        previewBlock.Position = snappedPos
        previewBlock.BrickColor = BrickColor.new("Bright green")
        previewBlock.Transparency = 0.3
    else
        previewBlock.Position = Vector3.new(0, 1000, 0)
        previewBlock.BrickColor = BrickColor.new("Bright red")
    end
end)

-- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º API –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
return BuildingAPI